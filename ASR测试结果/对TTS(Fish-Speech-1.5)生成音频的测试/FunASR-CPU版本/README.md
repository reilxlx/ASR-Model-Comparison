# FunASR CPU 部署与测试指南

## 1. 环境配置

### 1.1 拉取 Docker 镜像
```bash
sudo docker pull \
  registry.cn-hangzhou.aliyuncs.com/funasr_repo/funasr:funasr-runtime-sdk-cpu-0.4.6
```

### 1.2 创建模型目录并启动容器
```bash
mkdir -p ./funasr-runtime-resources/models
sudo docker run -p 10096:10095 -it --privileged=true \
  -v $PWD/funasr-runtime-resources/models:/workspace/models \
  registry.cn-hangzhou.aliyuncs.com/funasr_repo/funasr:funasr-runtime-sdk-cpu-0.4.6
```

### 1.3 进入容器
```bash
docker exec -it <容器ID> /bin/bash
```

## 2. 启动服务

### 2.1 启动 FunASR 服务
```bash
cd FunASR/runtime
nohup bash run_server.sh \
  --download-model-dir /workspace/models \
  --vad-dir damo/speech_fsmn_vad_zh-cn-16k-common-onnx \
  --model-dir damo/speech_paraformer-large-vad-punc_asr_nat-zh-cn-16k-common-vocab8404-onnx \
  --punc-dir damo/punc_ct-transformer_cn-en-common-vocab471067-large-onnx \
  --lm-dir damo/speech_ngram_lm_zh-cn-ai-wesp-fst \
  --itn-dir thuduj12/fst_itn_zh \
  --hotword /workspace/models/hotwords.txt \
  --certfile 0 > log.txt 2>&1 &
```

## 3. 测试命令

### 3.1 单条语音转写测试
```bash
python3 funasr_wss_client.py --host "127.0.0.1" --port 10096 --mode offline \
    --audio_in "../audio/asr_example.wav" --output_dir "./results" --ssl 0 --thread_num 1
```

### 3.2 批量语音转写测试
```bash
python batch_transcribe.py \
    --input-dir /root/home/fish-speech-liutao-16k/ \
    --output-file ./transcriptions_funasr_cpu.txt \
    --api-url http://127.0.0.1:8000/transcribe?host=127.0.0.1&port=10096&mode=offline&ssl=false&use_itn=true&audio_fs=16000
```

#### 3.2.1 批量测试结果（171个文件）
```
2025-05-02 17:25:28,154 - INFO - Finished processing all files.
2025-05-02 17:25:28,154 - INFO - ------------------------------
2025-05-02 17:25:28,154 - INFO - Batch Processing Summary
2025-05-02 17:25:28,154 - INFO - ------------------------------
2025-05-02 17:25:28,154 - INFO - Total files found:         171
2025-05-02 17:25:28,154 - INFO - Successfully processed:    171
2025-05-02 17:25:28,154 - INFO - Failed to process:         0
2025-05-02 17:25:28,154 - INFO - Total batch duration:      0:01:55.110144
2025-05-02 17:25:28,154 - INFO - Total API request time (successful): 0:01:55.073346
2025-05-02 17:25:28,154 - INFO - Average API request time per successful file: 0.67 seconds
```

## 4. 性能压测

### 4.1 压测命令
```bash
python load_test_by_txt_tqdm.py \
    --url "http://127.0.0.1:8000/transcribe?host=127.0.0.1&port=10096&mode=offline&ssl=false&use_itn=true&audio_fs=16000" \
    --audio-file "/root/home/fish-speech-liutao-16k/sentence_104.wav" \
    --concurrency-levels "1,5,10,15,20,25,30" \
    --requests-per-level 500
```

#### 4.1.1 压测结果
```
root@ubuntu22:/workspace/samples/python# python load_test_by_txt_tqdm.py \
    --url "http://127.0.0.1:8000/transcribe?host=127.0.0.1&port=10096&mode=offline&ssl=false&use_itn=true&audio_fs=16000" \
    --audio-file "/root/home/reilx/fish-speech-liutao-16k/sentence_104.wav" \
    --concurrency-levels "1,5,10,15,20,25,30" \
    --requests-per-level 500
Starting load test...
API URL: http://127.0.0.1:8000/transcribe?host=127.0.0.1&port=10096&mode=offline&ssl=false&use_itn=true&audio_fs=16000
Audio File: /root/home/reilx/fish-speech-liutao-16k/sentence_104.wav
Requests per level: 500
Concurrency levels: [1, 5, 10, 15, 20, 25, 30]
Expected Text (start): '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这款产品本金相对安全，其预期收益与特定的市...'
----------------------------------------
Running Conc=1:   0%|                                                                                                                                                                                                                                                                               | 0/7 [00:00<?, ?level/s]2025-05-02 17:33:20,470 - INFO - Success Criterion: Exact match for text starting with '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这...'
2025-05-02 17:33:20,471 - INFO - Loaded audio file: sentence_104.wav (1089372 bytes)
Conc=1  : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [20:02<00:00,  2.40s/req]
Conc=1  : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [20:02<00:00,  2.41s/req]
--- Test Summary: Concurrency=1 ---
Total Requests Sent:      500
Successful Requests (Exact Match): 500
Failed Requests:          0
Success Rate (Exact Match): 100.00%
Total Test Duration:      0:20:02.491348
Avg. Resp. Time (Success):2.405 seconds
Status Code Counts:       {200: 500}
--- Test Finished: Concurrency=1 ---

Running Conc=5:  14%|█████████████████████████████████████                                                                                                                                                                                                                              | 1/7 [20:02<2:00:14, 1202.49s/level]2025-05-02 17:53:22,963 - INFO - Success Criterion: Exact match for text starting with '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这...'
2025-05-02 17:53:22,964 - INFO - Loaded audio file: sentence_104.wav (1089372 bytes)
Conc=5  : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [04:29<00:00,  1.86req/s]
Conc=5  : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [04:29<00:00,  1.99req/s]
--- Test Summary: Concurrency=5 ---
Total Requests Sent:      500
Successful Requests (Exact Match): 500
Failed Requests:          0
Success Rate (Exact Match): 100.00%
Total Test Duration:      0:04:29.261188
Avg. Resp. Time (Success):2.681 seconds
Status Code Counts:       {200: 500}
--- Test Finished: Concurrency=5 ---

Running Conc=10:  29%|██████████████████████████████████████████████████████████████████████████▌                                                                                                                                                                                          | 2/7 [24:31<54:27, 653.53s/level]2025-05-02 17:57:52,226 - INFO - Success Criterion: Exact match for text starting with '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这...'
2025-05-02 17:57:52,226 - INFO - Loaded audio file: sentence_104.wav (1089372 bytes)
Conc=10 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [03:10<00:00,  2.62req/s]
Conc=10 : 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍| 499/500 [03:10<00:00,  3.33req/s]
--- Test Summary: Concurrency=10 ---
Total Requests Sent:      500
Successful Requests (Exact Match): 500
Failed Requests:          0
Success Rate (Exact Match): 100.00%
Total Test Duration:      0:03:10.672153
Avg. Resp. Time (Success):3.790 seconds
Status Code Counts:       {200: 500}
--- Test Finished: Concurrency=10 ---

Running Conc=15:  43%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                                                                                                                     | 3/7 [27:42<29:28, 442.18s/level]2025-05-02 18:01:02,899 - INFO - Success Criterion: Exact match for text starting with '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这...'
2025-05-02 18:01:02,899 - INFO - Loaded audio file: sentence_104.wav (1089372 bytes)
Conc=15 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [02:36<00:00,  3.19req/s]
Conc=15 : 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍| 499/500 [02:36<00:00,  4.35req/s]
--- Test Summary: Concurrency=15 ---
Total Requests Sent:      500
Successful Requests (Exact Match): 500
Failed Requests:          0
Success Rate (Exact Match): 100.00%
Total Test Duration:      0:02:36.900811
Avg. Resp. Time (Success):4.666 seconds
Status Code Counts:       {200: 500}
--- Test Finished: Concurrency=15 ---

Running Conc=20:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                                                               | 4/7 [30:19<16:28, 329.56s/level]2025-05-02 18:03:39,801 - INFO - Success Criterion: Exact match for text starting with '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这...'
2025-05-02 18:03:39,801 - INFO - Loaded audio file: sentence_104.wav (1089372 bytes)
Conc=20 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [02:40<00:00,  3.11req/s]
Conc=20 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [02:40<00:00,  5.25req/s]
--- Test Summary: Concurrency=20 ---
Total Requests Sent:      500
Successful Requests (Exact Match): 500
Failed Requests:          0
Success Rate (Exact Match): 100.00%
Total Test Duration:      0:02:40.886038
Avg. Resp. Time (Success):6.350 seconds
Status Code Counts:       {200: 500}
--- Test Finished: Concurrency=20 ---

Running Conc=25:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                                          | 5/7 [33:00<08:57, 268.73s/level]2025-05-02 18:06:20,688 - INFO - Success Criterion: Exact match for text starting with '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这...'
2025-05-02 18:06:20,689 - INFO - Loaded audio file: sentence_104.wav (1089372 bytes)
Conc=25 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [02:40<00:00,  3.12req/s]
Conc=25 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [02:40<00:00,  7.22req/s]
--- Test Summary: Concurrency=25 ---
Total Requests Sent:      500
Successful Requests (Exact Match): 500
Failed Requests:          0
Success Rate (Exact Match): 100.00%
Total Test Duration:      0:02:40.146440
Avg. Resp. Time (Success):7.872 seconds
Status Code Counts:       {200: 500}
--- Test Finished: Concurrency=25 ---

Running Conc=30:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                                     | 6/7 [35:40<03:51, 231.81s/level]2025-05-02 18:09:00,836 - INFO - Success Criterion: Exact match for text starting with '我们注意到您近期咨询了关于我行星推出的一款结构性理财产品。这...'
2025-05-02 18:09:00,836 - INFO - Loaded audio file: sentence_104.wav (1089372 bytes)
Conc=30 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [02:40<00:00,  3.12req/s]
Conc=30 : 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [02:40<00:00,  4.84req/s]
--- Test Summary: Concurrency=30 ---
Total Requests Sent:      500
Successful Requests (Exact Match): 500
Failed Requests:          0
Success Rate (Exact Match): 100.00%
Total Test Duration:      0:02:40.154340
Avg. Resp. Time (Success):9.381 seconds
Status Code Counts:       {200: 500}
--- Test Finished: Concurrency=30 ---

Running Conc=30: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [38:20<00:00, 328.65s/level]
========================================
Overall Load Test Complete
========================================
```

#### 4.1.2 结果分析
**分析:**

1.  **可靠性与准确性 (依然完美):**
    *   **观察:** 与之前的测试一样，在所有测试的并发级别下（1 到 30），`成功率 (精确匹配)` 维持在 **100%**。失败请求数仍然为 **零**。
    *   **结论:** 连接到端口 10096 的服务同样表现出极高的稳定性和准确性。它能够稳定处理高达 30 个并发任务，并为 `sentence_104.wav` 提供正确的转录结果。

2.  **性能与延迟 (与端口 10098 相比显著变差):**
    *   **观察:** `平均响应时间（成功请求）` 同样随并发增加而增长，但**起点更高，增长也更快**：
        *   并发 1: **2.405 秒** (对比 10098 的 1.276 秒)
        *   并发 5: **2.681 秒** (+0.28 秒) (对比 10098 的 1.401 秒)
        *   并发 10: **3.790 秒** (+1.11 秒) (对比 10098 的 1.698 秒)
        *   并发 15: **4.666 秒** (+0.88 秒) (对比 10098 的 2.425 秒)
        *   并发 20: **6.350 秒** (+1.68 秒) (对比 10098 的 3.291 秒)
        *   并发 25: **7.872 秒** (+1.52 秒) (对比 10098 的 4.100 秒)
        *   并发 30: **9.381 秒** (+1.51 秒) (对比 10098 的 4.939 秒)
    *   **结论:**
        *   **基础延迟更高:** 即使在单并发下，端口 10096 的响应时间（2.4 秒）也几乎是端口 10098（1.3 秒）的两倍。这表明端口 10096 对应的服务本身处理单个请求就更慢，或者其所依赖的资源（如特定 GPU 或 CPU 核心）性能较差。
        *   **负载下延迟增长更快:** 随着并发数的增加，端口 10096 的延迟增长幅度更大。在并发 30 时，其平均延迟（9.4 秒）几乎是端口 10098（4.9 秒）的两倍。这表明端口 10096 的服务更容易受到并发负载的影响，资源瓶颈更早出现或更严重。

3.  **吞吐量 (显著低于端口 10098):**
    *   **观察:** 计算近似 RPS：
        *   并发 1: 500 / (20\*60 + 2.5) ≈ 500 / 1202.5 ≈ **0.42 RPS** (对比 10098 的 ~0.78 RPS)
        *   并发 5: 500 / (4\*60 + 29.3) ≈ 500 / 269.3 ≈ **1.86 RPS** (对比 10098 的 ~3.56 RPS)
        *   并发 10: 500 / (3\*60 + 10.7) ≈ 500 / 190.7 ≈ **2.62 RPS** (对比 10098 的 ~5.86 RPS)
        *   并发 15: 500 / (2\*60 + 36.9) ≈ 500 / 156.9 ≈ **3.19 RPS** (对比 10098 的 ~6.16 RPS)
        *   并发 20: 500 / (2\*60 + 40.9) ≈ 500 / 160.9 ≈ **3.11 RPS**
        *   并发 25: 500 / (2\*60 + 40.1) ≈ 500 / 160.1 ≈ **3.12 RPS**
        *   并发 30: 500 / (2\*60 + 40.2) ≈ 500 / 160.2 ≈ **3.12 RPS**
    *   **结论:**
        *   **峰值吞吐量低:** 端口 10096 服务的峰值吞吐量大约在 **3.1-3.2 RPS** 左右，远低于端口 10098 的约 6 RPS。
        *   **饱和点更早:** 系统似乎在 **并发 15** 左右就达到了吞吐量饱和点，并且在此之后吞吐量几乎不再增长。

4.  **稳定性 (依然优秀):**
    *   **观察:** 所有请求均返回 HTTP `200` 状态码，没有报告任何失败。
    *   **结论:** 尽管性能较差，连接到端口 10096 的服务在测试负载下仍然保持稳定，没有出现错误或崩溃。

**综合信息与结论:**

*   **端口 10096 vs 10098:** 这次测试的核心发现是**端口 10096 对应的 ASR 服务实例性能显著低于端口 10098**。
*   **性能指标 (10096):**
    *   **准确性和稳定性:** 非常高，与 10098 相当。
    *   **延迟:** 基础延迟更高，且随负载增加更快。
    *   **吞吐量:** 峰值吞吐量约为 3.1-3.2 RPS，大约是 10098 的一半。
    *   **饱和点:** 大约在并发 15 左右达到。
*   **可能原因:**
    *   **资源分配不均:** 端口 10096 和 10098 可能映射到不同的物理服务器、虚拟机或 Docker 容器，而这些底层资源（CPU 核心数、GPU 型号/数量、内存）分配不均衡。端口 10096 可能分配到的资源较少或较差。
    *   **模型/配置差异:** 两个端口可能运行着配置略有不同的 ASR 模型实例（虽然测试参数看起来相同）。
    *   **后台干扰:** 运行端口 10096 服务的机器/容器上可能存在其他干扰进程，占用了资源。
*   **结论启示:** 如果这两个端口旨在提供相同的服务能力，那么存在明显的性能不一致。需要检查端口 10096 服务实例的资源分配、配置以及运行环境，找出性能较低的原因并进行优化或调整，以实现更均衡的服务能力。如果它们设计上就是不同性能等级的服务，那么这个测试结果就反映了这种差异。